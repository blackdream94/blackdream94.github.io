<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/favicon.ico?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="技术博客">
<meta property="og:type" content="website">
<meta property="og:title" content="黑梦">
<meta property="og:url" content="http://example.com/page/3/index.html">
<meta property="og:site_name" content="黑梦">
<meta property="og:description" content="技术博客">
<meta property="og:locale">
<meta property="article:author" content="blackdream">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://example.com/page/3/"/>





  <title>黑梦</title>
  








<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">黑梦</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">个人博客</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            分类
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/php/b7833455/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黑梦">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/php/b7833455/" itemprop="url">PHP 导出数据到EXCEL时数字自动变为科学计数法的最简单解决方法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-01-21T10:30:00+08:00">
                2021-01-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/" itemprop="url" rel="index">
                    <span itemprop="name">php</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  186
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>转自：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43674113/article/details/103601398">https://blog.csdn.net/weixin_43674113/article/details/103601398</a></p>
<p>用程序导出的csv文件，当字段中有比较长的数字字段存在时，在用excel软件查看csv文件时就会变成科学技术法的表现形式。<br>其实这个问题跟用什么语言导出csv文件没有关系。Excel显示数字时，如果数字大于12位，它会自动转化为科学计数法；如果数字大于15位，它不仅用于科学技术法表示，还会只保留高15位，其他位都变0。<br>解决方式：（只要把数字字段后面加上显示上看不见的字符即可，字符串结尾加上制表符”\t”）<br>注意一定是”\t”，不是’\t’.</p>

          
        
      
    </div>
    
    
    
    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/php/6cbf48b/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黑梦">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/php/6cbf48b/" itemprop="url">PHP call_user_func() 和 call_user_func_array()</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-01-06T10:54:00+08:00">
                2021-01-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/" itemprop="url" rel="index">
                    <span itemprop="name">php</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  662
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  3
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>一、 call_user_func</p>
<p>作用</p>
<p>把第一个参数作为回调函数调用</p>
<p>说明</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call_user_func ( <span class="keyword">callable</span> <span class="variable">$callback</span> [, <span class="keyword">mixed</span> <span class="variable">$parameter</span> [, <span class="keyword">mixed</span> $... ]] ) : <span class="keyword">mixed</span></span><br></pre></td></tr></table></figure>

<p>第一个参数 callback 是被调用的回调函数，其余参数是回调函数的参数</p>
<p>用法</p>
<p>1.基本用法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.基本用法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">barber</span>(<span class="params"><span class="variable">$type</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">&#123;$type&#125;</span>&lt;br/&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">call_user_func(<span class="string">&#x27;barber&#x27;</span>, <span class="string">&quot;mushroom&quot;</span>);</span><br><span class="line">call_user_func(<span class="string">&#x27;barber&#x27;</span>, <span class="string">&quot;shave&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>2.使用命名空间</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Foobar</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="built_in">static</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">print</span> <span class="string">&quot;I&#x27;m <span class="subst">&#123;$name&#125;</span>.&lt;br/&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">call_user_func(<span class="keyword">__NAMESPACE__</span> . <span class="string">&#x27;\Foo::test&#x27;</span>, <span class="string">&#x27;Sim&#x27;</span>); <span class="comment">// 第一种</span></span><br><span class="line">call_user_func(<span class="keyword">array</span>(<span class="keyword">__NAMESPACE__</span> . <span class="string">&#x27;\Foo&#x27;</span>, <span class="string">&#x27;test&#x27;</span>), <span class="string">&#x27;Tony&#x27;</span>); <span class="comment">// 第二种</span></span><br></pre></td></tr></table></figure>

<p>3.调用类中方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 3.调用类中方法</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myclass</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">say_hello</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Hello!\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">say_bye</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Bye!\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.1静态方法的调用方式</span></span><br><span class="line"><span class="variable">$classname</span> = <span class="string">&quot;myclass&quot;</span>;</span><br><span class="line"></span><br><span class="line">call_user_func(<span class="keyword">array</span>(<span class="variable">$classname</span>, <span class="string">&#x27;say_hello&#x27;</span>));</span><br><span class="line">call_user_func(<span class="variable">$classname</span> . <span class="string">&#x27;::say_hello&#x27;</span>); <span class="comment">// As of 5.2.3</span></span><br><span class="line"><span class="variable">$myobject</span> = <span class="keyword">new</span> myclass();</span><br><span class="line"></span><br><span class="line">call_user_func(<span class="keyword">array</span>(<span class="variable">$myobject</span>, <span class="string">&#x27;say_hello&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.2非静态方法的调用方式</span></span><br><span class="line"><span class="comment">//当php &lt;5.3时，可以如下使用，此时会把 b()方法当作是a的一个静态方式。</span></span><br><span class="line">call_user_func(<span class="keyword">array</span>(<span class="string">&quot;myclass&quot;</span>, <span class="string">&quot;say_bye&quot;</span>));</span><br><span class="line"> </span><br><span class="line"><span class="comment">//当php &gt;=5.3时，类的公开的非静态的方法必须在类实例化后方可被调用，否则会提示Strict性错误（为了兼容先前及以后的版本，还是用对象方法传入）。</span></span><br><span class="line"><span class="variable">$obj</span> = <span class="keyword">new</span> myclass;</span><br><span class="line">call_user_func(<span class="keyword">array</span>(<span class="variable">$obj</span>, <span class="string">&quot;say_bye&quot;</span>)); <span class="comment">// bye</span></span><br></pre></td></tr></table></figure>

<p>二、call_user_func_array</p>
<p>和call_user_func很相似，不同点是把一个数组参数作为回调函数的参数</p>
<p>使用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.使用</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foobar</span>(<span class="params"><span class="variable">$arg</span>, <span class="variable">$arg2</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="keyword">__FUNCTION__</span>, <span class="string">&quot; got <span class="subst">$arg</span> and <span class="subst">$arg2</span>&lt;br/&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">foo</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bar</span>(<span class="params"><span class="variable">$arg</span>, <span class="variable">$arg2</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__METHOD__</span>, <span class="string">&quot; got <span class="subst">$arg</span> and <span class="subst">$arg2</span>&lt;br/&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">bar2</span>(<span class="params"><span class="variable">$arg</span>, <span class="variable">$arg2</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$arg</span> . <span class="string">&#x27; &#x27;</span> . <span class="variable">$arg2</span> . <span class="string">&#x27;&lt;br/&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.1 调用函数</span></span><br><span class="line">call_user_func_array(<span class="string">&quot;foobar&quot;</span>, <span class="keyword">array</span>(<span class="string">&quot;one&quot;</span>, <span class="string">&quot;two&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.2 调用类中方法</span></span><br><span class="line"><span class="comment">// 1.2.1 调用非静态方法</span></span><br><span class="line"><span class="comment">// php&lt;5.3时，非静态的方法可直接传入类名</span></span><br><span class="line">call_user_func_array(<span class="keyword">array</span>(<span class="string">&#x27;foo&#x27;</span>, <span class="string">&#x27;bar&#x27;</span>), <span class="keyword">array</span>(<span class="string">&quot;three&quot;</span>, <span class="string">&quot;four&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//php&gt;=5.3时，非静态的方法 只有在类被实例化后方可调用，否则会提示Strict性错误</span></span><br><span class="line"><span class="variable">$foo</span> = <span class="keyword">new</span> foo;</span><br><span class="line">call_user_func_array(<span class="keyword">array</span>(<span class="variable">$foo</span>, <span class="string">&quot;bar&quot;</span>), <span class="keyword">array</span>(<span class="string">&quot;three&quot;</span>, <span class="string">&quot;four&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.2.2 调用静态方法</span></span><br><span class="line">call_user_func_array(<span class="keyword">array</span>(<span class="string">&#x27;foo&#x27;</span>,<span class="string">&#x27;bar2&#x27;</span>), <span class="keyword">array</span>(<span class="string">&quot;five&quot;</span>, <span class="string">&quot;six&quot;</span>));</span><br><span class="line"><span class="comment">//或</span></span><br><span class="line">call_user_func_array(<span class="string">&#x27;foo::bar2&#x27;</span>, <span class="keyword">array</span>(<span class="string">&quot;five&quot;</span>, <span class="string">&quot;six&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>三、使用引用</p>
<p>传入call_user_func()的参数不能为引用传递</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用引用</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">incr</span>(<span class="params">&amp;<span class="variable">$b</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$b</span>++;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="variable">$c</span> = <span class="number">0</span>;</span><br><span class="line">call_user_func_array(<span class="string">&#x27;incr&#x27;</span>, <span class="keyword">array</span>(&amp;<span class="variable">$c</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$c</span>; <span class="comment">//显示 1</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.call-user-func.php">https://www.php.net/manual/zh/function.call-user-func.php</a></p>
<p>call_user_func ( <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.types.callable.php">callable</a> <code>$callback</code> [, <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.types.declarations.php#language.types.declarations.mixed">mixed</a> <code>$parameter</code> [, <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.types.declarations.php#language.types.declarations.mixed">mixed</a> <code>$...</code> ]] ) : <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.types.declarations.php#language.types.declarations.mixed">mixed</a></p>

          
        
      
    </div>
    
    
    
    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/php/d5c2c145/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黑梦">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/php/d5c2c145/" itemprop="url">PHP CURL的用法及上传图片</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-01-06T10:54:00+08:00">
                2021-01-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/" itemprop="url" rel="index">
                    <span itemprop="name">php</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  4
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>简介</p>
<p>curl是一个非常强大的开源库，可以使用URL的语法模拟浏览器来传输数据，支持多种协议，FTP, FTPS, HTTP, HTTPS, GOPHER, TELNET, DICT, FILE 以及 LDAP等协议都可以很好的支持，包括一些：HTTPS认证，HTTP POST方法，HTTP PUT方法，FTP上传，keyberos认证，HTTP上传，代理服务器，cookies，用户名/密码认证，下载文件断点续传，上传文件断点续传，http代理服务器管道，甚至它还支持IPv6，scoket5代理服务器，通过http代理服务器上传文件到FTP服务器等等，还可以抓取网页</p>
<p>您需要在php.ini中开启curl扩展才可以使用它</p>
<p>使用</p>
<p>基本步骤</p>
<p>先了解下它的基本步骤，分为4步</p>
<ol>
<li>初始化创建会话　　　curl_init()</li>
<li>设置属性　　　　　　curl_setopt()</li>
<li>执行并获取结果　　　curl_exec()</li>
<li>释放句柄　　　　　　curl_close()</li>
</ol>
<p>基础命令</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建了一个curl会话资源，成功返回一个句柄</span></span><br><span class="line"><span class="variable">$ch</span> = curl_init(); </span><br><span class="line"><span class="comment">//设置url</span></span><br><span class="line">curl_setopt(<span class="variable">$ch</span>, CURLOPT_URL, <span class="string">&quot;baidu.com&quot;</span>); </span><br><span class="line"><span class="comment">//如何处理获取的信息，1(true)：是以文件流的形式返回 0(false)：是直接echo输出</span></span><br><span class="line">curl_setopt(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>); </span><br><span class="line"><span class="comment">//设置为post请求，1：是 0：否</span></span><br><span class="line">curl_setopt(<span class="variable">$ch</span>, CURLOPT_POST,<span class="number">1</span>);</span><br><span class="line"><span class="comment">//请求默认超时时间</span></span><br><span class="line">curl_setopt(<span class="variable">$ch</span>, CURLOPT_TIMEOUT, <span class="number">60</span>);</span><br><span class="line"><span class="comment">//0 or false 为不检查证书 测试时候可以设置</span></span><br><span class="line">curl_setopt(<span class="variable">$ch</span>, CURLOPT_SSL_VERIFYHOST, <span class="literal">false</span>);</span><br><span class="line"><span class="comment">//post数据的时候进行数据提交，此命令略坑。</span></span><br><span class="line"><span class="comment">//使用 curl 并且参数为数据时，向服务器提交数据时，</span></span><br><span class="line"><span class="comment">//http头会发送content_type: application/x-www-form-urlencoded。</span></span><br><span class="line"><span class="comment">//这个是正常的网页&lt;form&gt;提交表单时，浏览器发送的头部。</span></span><br><span class="line"><span class="comment">//而 multipart/form-data 知道这是用于上传文件的表单。包括了 boundary 分界符，会多出很多字节。</span></span><br><span class="line"><span class="comment">//在没有需要上传文件的情况下，尽量对 post 提交的数据进行 http_build_query 处理,再发送</span></span><br><span class="line">curl_setopt(<span class="variable">$ch</span>, CURLOPT_POSTFIELDS, <span class="variable">$data</span>);</span><br><span class="line"><span class="comment">// 执行，然后将响应结果存入$output变量</span></span><br><span class="line"><span class="variable">$output</span> = curl_exec(<span class="variable">$ch</span>); </span><br><span class="line"><span class="comment">//捕获句柄执行错误信息</span></span><br><span class="line"><span class="variable">$error</span> = curl_error(<span class="variable">$ch</span>);</span><br><span class="line"><span class="comment">// 关闭这个curl会话资源</span></span><br><span class="line">curl_close(<span class="variable">$ch</span>);    </span><br></pre></td></tr></table></figure>

<p>curl_setopt可以用curl_setopt_array()代替，并将参数以数组的形式传入</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$opts</span> = <span class="keyword">array</span>(</span><br><span class="line">    CURLOPT_TIMEOUT =&gt; <span class="number">60</span>,</span><br><span class="line">    CURLOPT_RETURNTRANSFER =&gt; <span class="number">1</span>,</span><br><span class="line">    ...</span><br><span class="line">);</span><br><span class="line">curl_setopt_array(<span class="variable">$ch</span>, <span class="variable">$opts</span>);</span><br></pre></td></tr></table></figure>

<p>GET请求</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * GET请求</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $url 请求路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $params 请求参数数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int $timeout 超时时间</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">curlGet</span>(<span class="params"><span class="variable">$url</span>, <span class="variable">$params</span> = [], <span class="variable">$timeout</span> = <span class="number">5</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$url</span> = <span class="variable">$url</span> . <span class="string">&quot;?&quot;</span> . http_build_query(<span class="variable">$params</span>);</span><br><span class="line">    <span class="variable">$ch</span> = curl_init(<span class="variable">$url</span>);</span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>, CURLOPT_TIMEOUT, <span class="variable">$timeout</span>);</span><br><span class="line">    <span class="variable">$output</span>  = curl_exec(<span class="variable">$ch</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$output</span> === <span class="literal">FALSE</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;CURL GET Error:&quot;</span> . curl_error(<span class="variable">$ch</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    curl_close(<span class="variable">$ch</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$output</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>POST请求</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * POST</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $url 请求路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $params 请求参数数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int $timeout 超时时间</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">curlPost</span>(<span class="params"><span class="variable">$url</span>, <span class="variable">$params</span> = [], <span class="variable">$timeout</span> = <span class="number">5</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$curl</span> = curl_init(<span class="variable">$url</span>);</span><br><span class="line">    curl_setopt(<span class="variable">$curl</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">    curl_setopt(<span class="variable">$curl</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">    curl_setopt(<span class="variable">$curl</span>, CURLOPT_POST, <span class="number">1</span>);</span><br><span class="line">    curl_setopt(<span class="variable">$curl</span>, CURLOPT_POSTFIELDS, http_build_query(<span class="variable">$params</span>));</span><br><span class="line">    <span class="variable">$data</span> = curl_exec(<span class="variable">$curl</span>);</span><br><span class="line">    curl_close(<span class="variable">$curl</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上传图片</p>
<p>这里需要注意一个PHP版本的坑</p>
<p>在5.6版本以下在图片路径地址前加上@符号即可，而PHP5.6版本则需要使用新得方法new CURLFile(图片路径);方可执行。</p>
<p>或者还是用原来的方法在CURLOPT_POSTFIELDS设置项前加上CURLOPT_SAFE_UPLOAD设置项，设为FALSE。即curl_setopt($ch, CURLOPT_SAFE_UPLOAD, false);</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上传图片</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $url 上传地址</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $params 要上传的图片的路径</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">uploadImg</span>(<span class="params"><span class="variable">$url</span>, <span class="variable">$path</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$curlPost</span> = <span class="keyword">array</span>(<span class="string">&#x27;file&#x27;</span> =&gt; <span class="keyword">new</span> CURLFile(realpath(<span class="variable">$path</span>)));</span><br><span class="line">    <span class="variable">$ch</span> = curl_init();</span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>, CURLOPT_POST, <span class="number">1</span>); <span class="comment">//POST提交</span></span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>, CURLOPT_POSTFIELDS, <span class="variable">$curlPost</span>);</span><br><span class="line">    <span class="variable">$data</span> = curl_exec(<span class="variable">$ch</span>);</span><br><span class="line">    curl_close(<span class="variable">$ch</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另一台服务器接收传过来的图片并上传到服务器</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$path</span> = <span class="string">&#x27;img/&#x27;</span> . date(<span class="string">&#x27;Ymd&#x27;</span>); <span class="comment">// 上传路径</span></span><br><span class="line"><span class="keyword">if</span> (is_uploaded_file(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>])) &#123; <span class="comment">// 是否有上传文件</span></span><br><span class="line">    <span class="variable">$ext</span> = pathinfo(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>], PATHINFO_EXTENSION); <span class="comment">// 获取后缀名</span></span><br><span class="line">    <span class="variable">$newName</span> = time() . mt_rand() . <span class="string">&#x27;.&#x27;</span> . <span class="variable">$ext</span>; <span class="comment">// 用时间戳和随机数取名</span></span><br><span class="line">    <span class="keyword">if</span> (!file_exists(<span class="variable">$path</span>)) &#123; <span class="comment">// 检测目录是否存在</span></span><br><span class="line">        <span class="keyword">if</span> (!mkdir(<span class="variable">$path</span>, <span class="number">0775</span>, <span class="literal">true</span>)) &#123; <span class="comment">// 创建目录</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;创建目录失败&#x27;</span>;</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], <span class="variable">$path</span> . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$newName</span>)) &#123; <span class="comment">// 将上传的文件移动到新位置</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;上传成功&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;上传失败&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    
    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/javascript/774c2087/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黑梦">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/javascript/774c2087/" itemprop="url">微信JS-SDK wx.chooseImage选择并预览图片，并上传到自己服务器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-01-06T10:05:00+08:00">
                2021-01-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/javascript/" itemprop="url" rel="index">
                    <span itemprop="name">javascript</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2.3k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  10
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>转自：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/342672565">https://zhuanlan.zhihu.com/p/342672565</a></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>我想要达成一个选择完图片就可以直接预览的效果，文档中也写明了localId可以作为img的src属性显示图片，</p>
<p>我的操作是，选择完图片之后，直接将 localId 赋给 img的src属性，但是结果不显示</p>
<p>通过搜贴，发现自己忽略了文档中的这一条信息</p>
<p><img src="../../images/wxjs-sdk_wx.chooseImage%E9%80%89%E6%8B%A9%E5%B9%B6%E9%A2%84%E8%A7%88%E5%9B%BE%E7%89%87%E5%B9%B6%E4%B8%8A%E4%BC%A0%E5%88%B0%E8%87%AA%E5%B7%B1%E6%9C%8D%E5%8A%A1%E5%99%A8/2020519-20210115102751259-563109486.png" alt="img"></p>
<p>不显示原因有二</p>
<ol>
<li>版本低于1.2.0，我使用的是1.0.0</li>
<li>用 getLocalImgData 接口获取的数据，苹果可以直接赋值，但是安卓有一个坑，在拼接前需要对localData进行换行符的全局替换</li>
</ol>
<h2 id="wx-chooseImage选择并预览图片，并上传到自己服务器"><a href="#wx-chooseImage选择并预览图片，并上传到自己服务器" class="headerlink" title="wx.chooseImage选择并预览图片，并上传到自己服务器"></a>wx.chooseImage选择并预览图片，并上传到自己服务器</h2><h3 id="注意-引入JS文件"><a href="#注意-引入JS文件" class="headerlink" title="注意 引入JS文件"></a>注意 引入JS文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 推荐使用1.3.2以上的版本，之前的版本很多坑 </span><br><span class="line">https://res.wx.qq.com/open/js/jweixin-1.3.2.js</span><br><span class="line">// 也可以用npm包</span><br><span class="line">npm install weixin-js-sdk</span><br></pre></td></tr></table></figure>

<h3 id="选择图片"><a href="#选择图片" class="headerlink" title="选择图片"></a>选择图片</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wx.chooseImage(&#123;</span><br><span class="line">    <span class="attr">count</span>: <span class="number">1</span>, <span class="comment">// 默认9</span></span><br><span class="line">    <span class="attr">sizeType</span>: [<span class="string">&#x27;original&#x27;</span>, <span class="string">&#x27;compressed&#x27;</span>], <span class="comment">// 可以指定是原图还是压缩图，默认二者都有</span></span><br><span class="line">    <span class="attr">sourceType</span>: [<span class="string">&#x27;album&#x27;</span>, <span class="string">&#x27;camera&#x27;</span>], <span class="comment">// 可以指定来源是相册还是相机，默认二者都有</span></span><br><span class="line">    <span class="attr">success</span>: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> localIds = res.localIds; <span class="comment">// array,返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="处理图片数据为base64"><a href="#处理图片数据为base64" class="headerlink" title="处理图片数据为base64"></a>处理图片数据为base64</h3><p><code>wx.chooseImage</code>获取到的图片为一个临时路径，微信同时提供了<code>wx.getLocalImgData</code>方法可以把获取到的路径转为base64格式的数据，至此就可以轻松许多了，但是转出来的base64在android和iOS中稍有不同，需要特别注意一下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">wx.getLocalImgData(&#123;</span><br><span class="line">          <span class="attr">localId</span>: res.localIds[<span class="number">0</span>], <span class="comment">// 图片的localID</span></span><br><span class="line">          <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">const</span> localData = res.localData;</span><br><span class="line">            <span class="keyword">let</span> imageBase64 = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">if</span> (localData.indexOf(<span class="string">&#x27;data:image&#x27;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">              <span class="comment">//苹果的直接赋值，默认生成&#x27;data:image/jpeg;base64,&#x27;的头部拼接</span></span><br><span class="line">              imageBase64 = localData;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="comment">//此处是安卓中的唯一得坑！在拼接前需要对localData进行换行符的全局替换</span></span><br><span class="line">              <span class="comment">//此时一个正常的base64图片路径就完美生成赋值到img的src中了</span></span><br><span class="line">              imageBase64 = <span class="string">&#x27;data:image/jpeg;base64,&#x27;</span> + localData.replace(<span class="regexp">/\n/g</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            $(<span class="string">&#x27;#img&#x27;</span>).attr(<span class="string">&#x27;src&#x27;</span>, imageBase64);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="上传图片"><a href="#上传图片" class="headerlink" title="上传图片"></a>上传图片</h3><p>获取到图片的base64数据之后其实我们就可以为所欲为了，不需要使用<code>wx.uploadImage</code>和<code>wx.downloadImage</code>了，不仅需要麻烦的上传到微信服务器，还有三天的时间限制反而增加了成本，最好的方式就是直接上传至我们自己的服务器。</p>
<p>一般与服务端交互的这种文件类型一般采用表单提交–multipart/form-data的方式，这就要求我们熟悉传输form-data的数据交互，所以需要把刚才获取到的base64转为可post的二进制数据，JavaScript提供了原生的<code>atob/btoa</code>用来对base64进行编码和解码；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dataURLtoBlob</span>(<span class="params">dataurl</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> arr = dataurl.split(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> mime = arr[<span class="number">0</span>].match(<span class="regexp">/:(.*?);/</span>)[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">let</span> bstr = atob(arr[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">let</span> n = bstr.length;</span><br><span class="line">    <span class="keyword">let</span> u8arr = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(n);</span><br><span class="line">    <span class="keyword">while</span> (n--) &#123;</span><br><span class="line">      u8arr[n] = bstr.charCodeAt(n);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Blob([u8arr], &#123;</span><br><span class="line">      <span class="attr">type</span>: mime</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<p>ok,处理好可交互的数据就可以上传到自己的服务器了，之后相当于普通H5页面的图片交互了,可上传可下载</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> param = <span class="keyword">new</span> FormData();</span><br><span class="line">param.append(<span class="string">&#x27;headPic&#x27;</span>, imageData);</span><br><span class="line">$.ajax(&#123;</span><br><span class="line">  <span class="attr">url</span>: <span class="string">&quot;http://www.xxx.com/upimg.php&quot;</span>, <span class="comment">// 填写你的url地址</span></span><br><span class="line">  <span class="attr">type</span>: <span class="string">&quot;post&quot;</span>,</span><br><span class="line">  <span class="attr">data</span>: param,</span><br><span class="line">  <span class="attr">dataType</span>: <span class="string">&#x27;JSON&#x27;</span>, <span class="comment">// 服务器响应的数据类型</span></span><br><span class="line">  <span class="attr">processData</span>: <span class="literal">false</span>, <span class="comment">// 因为data值是FormData对象，不需要对数据做处理</span></span><br><span class="line">  <span class="attr">contentType</span>: <span class="literal">false</span>, <span class="comment">// 告诉jQuery不要去设置Content-Type请求头</span></span><br><span class="line">  <span class="attr">cache</span>: <span class="literal">false</span>, <span class="comment">// 上传文件不需要缓存</span></span><br><span class="line">  <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    alert(<span class="string">&#x27;请求成功&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>后台获取到的代码是这样的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$_FILES</span>) &#123;</span><br><span class="line">    file_put_contents(<span class="string">&#x27;../test.log&#x27;</span>, json_encode(<span class="variable">$_FILES</span>));</span><br><span class="line">    <span class="keyword">echo</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &#123;&quot;headPic&quot;:&#123;&quot;name&quot;:&quot;blob&quot;,&quot;type&quot;:&quot;image\/jpg&quot;,&quot;tmp_name&quot;:&quot;\/tmp\/phpX8kcxh&quot;,&quot;error&quot;:0,&quot;size&quot;:37937&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>之后就可以在后台完成上传代码的操作的，服务器接收传过来的图片并上传到服务器的操作，请参考 —— <a target="_blank" rel="noopener" href="https://www.cnblogs.com/jiuhefree/articles/14239805.html">《PHP CURL的用法及上传图片》</a>，在最下面的一段代码</p>
<h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><p>我这个是直接在官方示例模板中改写的，官方示例下载地址：<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html#67">https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html#67</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"> <span class="keyword">require_once</span> <span class="string">&quot;jssdk.php&quot;</span>;</span><br><span class="line"> <span class="variable">$jssdk</span> = <span class="keyword">new</span> JSSDK(<span class="string">&quot;你的appId&quot;</span>, <span class="string">&quot;你的appSecret&quot;</span>);</span><br><span class="line"> <span class="variable">$signPackage</span> = <span class="variable">$jssdk</span>-&gt;GetSignPackage();</span><br><span class="line"> <span class="meta">?&gt;</span></span><br><span class="line"> &lt;!DOCTYPE html&gt;</span><br><span class="line"> &lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line"> </span><br><span class="line"> &lt;head&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">   &lt;meta content=<span class="string">&quot;width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0&quot;</span> name=<span class="string">&quot;viewport&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;&lt;/title&gt;</span><br><span class="line"> &lt;/head&gt;</span><br><span class="line"> </span><br><span class="line"> &lt;body&gt;</span><br><span class="line">   &lt;button id=<span class="string">&quot;button2&quot;</span>&gt;拍照或从手机相册中选图接口&lt;/button&gt;&lt;br /&gt;</span><br><span class="line">   &lt;button onclick=<span class="string">&quot;updateImg()&quot;</span>&gt;确认上传&lt;/button&gt;&lt;br /&gt;</span><br><span class="line">   &lt;img src=<span class="string">&quot;&quot;</span> id=<span class="string">&quot;img&quot;</span> width=<span class="string">&quot;150px&quot;</span> height=<span class="string">&quot;150px&quot;</span>&gt;&lt;br /&gt;</span><br><span class="line"> &lt;/body&gt;</span><br><span class="line"> &lt;script src=<span class="string">&quot;https://cdn.bootcss.com/jquery/3.4.1/jquery.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line"> &lt;script src=<span class="string">&quot;https://res.wx.qq.com/open/js/jweixin-1.6.0.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line"> &lt;script&gt;</span><br><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 注意：</span></span><br><span class="line"><span class="comment">    * 1. 所有的JS接口只能在公众号绑定的域名下调用，公众号开发者需要先登录微信公众平台进入“公众号设置”的“功能设置”里填写“JS接口安全域名”。</span></span><br><span class="line"><span class="comment">    * 2. 如果发现在 Android 不能分享自定义内容，请到官网下载最新的包覆盖安装，Android 自定义分享接口需升级至 6.0.2.58 版本及以上。</span></span><br><span class="line"><span class="comment">    * 3. 常见问题及完整 JS-SDK 文档地址：http://mp.weixin.qq.com/wiki/7/aaa137b55fb2e0456bf8dd9148dd613f.html</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * 开发中遇到问题详见文档“附录5-常见错误及解决办法”解决，如仍未能解决可通过以下渠道反馈：</span></span><br><span class="line"><span class="comment">    * 邮箱地址：weixin-open<span class="doctag">@qq</span>.com</span></span><br><span class="line"><span class="comment">    * 邮件主题：【微信JS-SDK反馈】具体问题</span></span><br><span class="line"><span class="comment">    * 邮件内容说明：用简明的语言描述问题所在，并交代清楚遇到该问题的场景，可附上截屏图片，微信团队会尽快处理你的反馈。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   wx.config(&#123;</span><br><span class="line">     debug: <span class="literal">false</span>, <span class="comment">// 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。</span></span><br><span class="line">     appId: <span class="string">&#x27;&lt;?php echo $signPackage[&quot;appId&quot;]; ?&gt;&#x27;</span>, <span class="comment">// 必填</span></span><br><span class="line">     timestamp: <span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="variable">$signPackage</span>[<span class="string">&quot;timestamp&quot;</span>]; <span class="meta">?&gt;</span>, <span class="comment">// 必填，生成签名的时间戳</span></span><br><span class="line">     nonceStr: <span class="string">&#x27;&lt;?php echo $signPackage[&quot;nonceStr&quot;]; ?&gt;&#x27;</span>, <span class="comment">// 必填，生成签名的随机串</span></span><br><span class="line">     signature: <span class="string">&#x27;&lt;?php echo $signPackage[&quot;signature&quot;]; ?&gt;&#x27;</span>, <span class="comment">// 必填，签名</span></span><br><span class="line">     jsApiList: [ <span class="comment">// 必填</span></span><br><span class="line">       <span class="comment">// 所有要调用的 API 都要加到这个列表中</span></span><br><span class="line">       <span class="string">&#x27;onMenuShareAppMessage&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;chooseImage&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;getLocalImgData&#x27;</span></span><br><span class="line">     ]</span><br><span class="line">   &#125;);</span><br><span class="line">   wx.ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">     <span class="comment">// config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。</span></span><br><span class="line">     <span class="comment">// 在这里调用 API</span></span><br><span class="line">   &#125;);</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">var</span> image_base64 = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"> </span><br><span class="line">   $(<span class="string">&#x27;#button2&#x27;</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">     <span class="keyword">var</span> images = &#123;</span><br><span class="line">       localId: [],</span><br><span class="line">       serverId: []</span><br><span class="line">     &#125;;</span><br><span class="line">     <span class="comment">// 选择图片</span></span><br><span class="line">    wx.chooseImage(&#123;</span><br><span class="line">       count: <span class="number">1</span>, <span class="comment">// 默认9</span></span><br><span class="line">       sizeType: [<span class="string">&#x27;original&#x27;</span>, <span class="string">&#x27;compressed&#x27;</span>], <span class="comment">// 可以指定是原图还是压缩图，默认二者都有</span></span><br><span class="line">       sourceType: [<span class="string">&#x27;album&#x27;</span>, <span class="string">&#x27;camera&#x27;</span>], <span class="comment">// 可以指定来源是相册还是相机，默认二者都有</span></span><br><span class="line">       success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">         <span class="comment">// wx.chooseImage获取到的图片为一个临时路径，微信同时提供了wx.getLocalImgData方法可以把获取到的路径转为base64格式的数据，至此就可以轻松许多了，但是转出来的base64在android和iOS中稍有不同</span></span><br><span class="line">         wx.getLocalImgData(&#123;</span><br><span class="line">           localId: res.localIds[<span class="number">0</span>], <span class="comment">// 图片的localID</span></span><br><span class="line">           success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">             <span class="keyword">const</span> localData = res.localData;</span><br><span class="line">             let imageBase64 = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">             <span class="keyword">if</span> (localData.indexOf(<span class="string">&#x27;data:image&#x27;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">               <span class="comment">//苹果的直接赋值，默认生成&#x27;data:image/jpeg;base64,&#x27;的头部拼接</span></span><br><span class="line">               imageBase64 = localData;</span><br><span class="line">             &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">//此处是安卓中的唯一得坑！在拼接前需要对localData进行换行符的全局替换</span></span><br><span class="line">               <span class="comment">//此时一个正常的base64图片路径就完美生成赋值到img的src中了</span></span><br><span class="line">               imageBase64 = <span class="string">&#x27;data:image/jpeg;base64,&#x27;</span> + localData.replace(/\n/g, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">             &#125;</span><br><span class="line">             image_base64 = imageBase64;</span><br><span class="line">             $(<span class="string">&#x27;#img&#x27;</span>).attr(<span class="string">&#x27;src&#x27;</span>, imageBase64);</span><br><span class="line">           &#125;</span><br><span class="line">         &#125;);</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;);</span><br><span class="line">   &#125;);</span><br><span class="line"> </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 点击上传图片按钮</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">updateImg</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (image_base64 == <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">       alert(<span class="string">&#x27;请先选择图片&#x27;</span>);</span><br><span class="line">       <span class="keyword">return</span>;</span><br><span class="line">     &#125;</span><br><span class="line">   handleAvatar(dataURLtoBlob(image_base64));</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * ajax上传图片</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">handleAvatar</span>(<span class="params">imageData</span>) </span>&#123;</span><br><span class="line">     <span class="keyword">var</span> param = <span class="keyword">new</span> FormData();</span><br><span class="line">     param.append(<span class="string">&#x27;headPic&#x27;</span>, imageData);</span><br><span class="line">     $.ajax(&#123;</span><br><span class="line">       url: <span class="string">&quot;http://www.xxx.com/upimg.php&quot;</span>, <span class="comment">// 填写你的url地址</span></span><br><span class="line">       type: <span class="string">&quot;post&quot;</span>,</span><br><span class="line">       data: param,</span><br><span class="line">       dataType: <span class="string">&#x27;JSON&#x27;</span>, <span class="comment">// 服务器响应的数据类型</span></span><br><span class="line">       processData: <span class="literal">false</span>, <span class="comment">// 因为data值是FormData对象，不需要对数据做处理</span></span><br><span class="line">       contentType: <span class="literal">false</span>, <span class="comment">// 告诉jQuery不要去设置Content-Type请求头</span></span><br><span class="line">       cache: <span class="literal">false</span>, <span class="comment">// 上传文件不需要缓存</span></span><br><span class="line">       success: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">         <span class="comment">// ...</span></span><br><span class="line">         alert(<span class="string">&#x27;请求成功&#x27;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;);</span><br><span class="line">   &#125;;</span><br><span class="line"> </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * base64转为可post的二进制数据</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">dataURLtoBlob</span>(<span class="params">dataurl</span>) </span>&#123;</span><br><span class="line">     let arr = dataurl.split(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">     let mime = arr[<span class="number">0</span>].<span class="keyword">match</span>(/:(.*?);/)[<span class="number">1</span>];</span><br><span class="line">     let bstr = atob(arr[<span class="number">1</span>]);</span><br><span class="line">     let n = bstr.length;</span><br><span class="line">     let u8arr = <span class="keyword">new</span> Uint8Array(n);</span><br><span class="line">     <span class="keyword">while</span> (n--) &#123;</span><br><span class="line">       u8arr[n] = bstr.charCodeAt(n);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> Blob([u8arr], &#123;</span><br><span class="line">       type: mime</span><br><span class="line">     &#125;);</span><br><span class="line">   &#125;;</span><br><span class="line"> &lt;/script&gt;</span><br><span class="line"> </span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    
    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/mysql/ad16af82/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黑梦">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/mysql/ad16af82/" itemprop="url">MySQL 利用mysqlbinlog二进制文件还原指定数据库</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-12-05T09:55:00+08:00">
                2020-12-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.3k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  6
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>推荐这篇 mysqlbinlog详解 - <a target="_blank" rel="noopener" href="https://www.cnblogs.com/Presley-lpc/p/9619571.html">https://www.cnblogs.com/Presley-lpc/p/9619571.html</a></p>
<h3 id="我的初始环境"><a href="#我的初始环境" class="headerlink" title="我的初始环境"></a>我的初始环境</h3><p>系统：CentOS 7.6.1810(Py3.7.8)</p>
<p>MySQL：5.7.31</p>
<h3 id="检查MySQL是否开启binlog日志"><a href="#检查MySQL是否开启binlog日志" class="headerlink" title="检查MySQL是否开启binlog日志"></a>检查MySQL是否开启binlog日志</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;log_bin&#x27;;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| log_bin       | ON    |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>log_bin为ON即为开启，</p>
<p>若未开启？</p>
<p>修改配置文件，在 [mysqld]下添加如下内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">log-bin=mysql-bin</span><br><span class="line">server-id = 1</span><br><span class="line">binlog_format=mixed</span><br><span class="line"></span><br><span class="line">#log-bin  开启 Binlog 并写明存放日志的位置；默认使用的设置是“log-bin=mysql-bin”，这样日志是存放在默认的位置上的，一般是放在data目录中。</span><br><span class="line"></span><br><span class="line">#server-id  指定一个集群内的 MySQL 服务器 ID，如果做数据库集群那么必须全局唯一，一般来说不推荐 指定 server_id 等于 1。</span><br><span class="line"></span><br><span class="line">#binlog_format  三种Bin-log日志模式 -- 自动模式</span><br></pre></td></tr></table></figure>

<p><img src="../../images/mysqlbinlog%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%E8%BF%98%E5%8E%9F%E6%8C%87%E5%AE%9A%E6%95%B0%E6%8D%AE%E5%BA%93/2020519-20201205091044237-1138203380.png" alt="img"></p>
<h3 id="模拟数据丢失"><a href="#模拟数据丢失" class="headerlink" title="模拟数据丢失"></a>模拟数据丢失</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">create database test;</span><br><span class="line">use test;</span><br><span class="line">create table t1(</span><br><span class="line">id int primary key,</span><br><span class="line">name varchar(32)</span><br><span class="line">);</span><br><span class="line"> </span><br><span class="line">INSERT INTO t1 VALUE(1,&#x27;val1&#x27;);</span><br><span class="line">INSERT INTO t1 VALUE(2,&#x27;val2&#x27;);</span><br><span class="line"></span><br><span class="line">create database test2;</span><br><span class="line">use test2;</span><br><span class="line">create table t1(</span><br><span class="line">id int primary key,</span><br><span class="line">name varchar(32)</span><br><span class="line">);</span><br><span class="line"> </span><br><span class="line">INSERT INTO t1 VALUE(1,&#x27;val1&#x27;);</span><br><span class="line">INSERT INTO t1 VALUE(2,&#x27;val2&#x27;);</span><br><span class="line"></span><br><span class="line">drop database test;</span><br><span class="line">drop database test2;</span><br></pre></td></tr></table></figure>

<h3 id="查看日志并恢复数据"><a href="#查看日志并恢复数据" class="headerlink" title="查看日志并恢复数据"></a>查看日志并恢复数据</h3><p>查看当前日志文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show master status;</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| mysql-bin.000001 |     4285 |              |                  |                   |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">1 row in set (0.06 sec)</span><br></pre></td></tr></table></figure>

<p>结果：说明 mysql-bin.000001 是当前备份的文件名</p>
<p>也可以直接进入/www/server/data，找到类似mysql-bin.000001的文件，选择后缀最大的文件，因为这个是最新的</p>
<p>如果找不到，可以全局搜索一下，使用 find / -name mysql-bin.000001; 去查看一下路径</p>
<p>由于binlog是二进制的，所以需要先转换成文本文件，一般可以采用Mysql自带的mysqlbinlog转换成文本。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/www/server/mysql/bin/mysqlbinlog --no-defaults --base64-output=&#x27;decode-rows&#x27; -v mysql-bin.000001 &gt; ./binlog_2020_12_07;</span><br></pre></td></tr></table></figure>

<p>部分参数说明：</p>
<ol>
<li>–no-defaults 为了防止报错：mysqlbinlog: unknown variable ‘default_character_set=utf8mb4’</li>
<li>–base64-output=’decode-rows’ 和-v一起使用， 进行base64解码</li>
<li>-d databaseName：可以使用-d来指定数据库</li>
<li>–start-datetime=”2020-12-07 14:27:36” ：指定开始时间，注意格式不要写错</li>
<li>–stop-datetime=”” ：指定结束时间</li>
<li>–start-position=”” ： 指定起始点</li>
<li>–stop-position=”” ：指定结束点</li>
</ol>
<p>之后导出文件 ‘binlog_2020_12_07’，我是直接在宝塔面板下载的，用vscode打开文本文件</p>
<p>会看到binlog的基本块如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># at 1488</span><br><span class="line">#201207 14:27:26 server id 1  end_log_pos 1569 CRC32 0xcb9c1cbf     Query    thread_id=178    exec_time=0    error_code=0</span><br><span class="line">SET TIMESTAMP=1607322446/*!*/;</span><br><span class="line">BEGIN</span><br></pre></td></tr></table></figure>

<p>基本块解释：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># at 1488</span><br><span class="line">指明的当前位置相对文件开始的偏移位置，这个在mysqlbinlog命令中可以作为--start-position的参数</span><br><span class="line"></span><br><span class="line">#201207 14:27:26 server id 1  end_log_pos 1569 CRC32 0xcb9c1cbf     Query    thread_id=178    exec_time=0    error_code=0</span><br><span class="line">201207 14:27:26指明时间为20年12月7号14:27:26，serverid也就是你在配置文件中的配置的，end_log_pos 1569，这个块在1569结束，也就是说结束点是1569。thread_id执行的线程id，exec_time执行时间，error_code错误码</span><br><span class="line"></span><br><span class="line">SET TIMESTAMP=1607322446/*!*/;</span><br><span class="line">BEGIN</span><br><span class="line">具体执行语句</span><br></pre></td></tr></table></figure>

<p>截取部分日志：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">/*!*/;</span><br><span class="line"># at 1852</span><br><span class="line">#201207 14:27:30 server id 1  end_log_pos 1958 CRC32 0xf8660231     Query    thread_id=178    exec_time=0    error_code=0</span><br><span class="line">SET TIMESTAMP=1607322450/*!*/;</span><br><span class="line">INSERT INTO t1 VALUE(2,&#x27;val2&#x27;)</span><br><span class="line">/*!*/;</span><br><span class="line"># at 1958</span><br><span class="line">#201207 14:27:30 server id 1  end_log_pos 1989 CRC32 0x3a49fcc1     Xid = 607</span><br><span class="line">COMMIT/*!*/;</span><br><span class="line"># at 1989</span><br><span class="line">#201207 14:27:36 server id 1  end_log_pos 2054 CRC32 0xa4d22816     Anonymous_GTID    last_committed=8    sequence_number=9    rbr_only=no</span><br><span class="line">SET @@SESSION.GTID_NEXT= &#x27;ANONYMOUS&#x27;/*!*/;</span><br><span class="line"># at 2054</span><br><span class="line">#201207 14:27:36 server id 1  end_log_pos 2146 CRC32 0x11bdfbca     Query    thread_id=178    exec_time=0    error_code=0</span><br><span class="line">SET TIMESTAMP=1607322456/*!*/;</span><br><span class="line">drop database test</span><br><span class="line">/*!*/;</span><br><span class="line"># at 2146</span><br><span class="line">#201207 14:27:42 server id 1  end_log_pos 2211 CRC32 0x9a60cd1d     Anonymous_GTID    last_committed=9    sequence_number=10    rbr_only=no</span><br><span class="line">SET @@SESSION.GTID_NEXT= &#x27;ANONYMOUS&#x27;/*!*/;</span><br><span class="line"># at 2211</span><br><span class="line">#201207 14:27:42 server id 1  end_log_pos 2306 CRC32 0xd29068e1     Query    thread_id=178    exec_time=0    error_code=0</span><br><span class="line">SET TIMESTAMP=1607322462/*!*/;</span><br><span class="line">drop database test2</span><br><span class="line">/*!*/;</span><br><span class="line">SET @@SESSION.GTID_NEXT= &#x27;AUTOMATIC&#x27; /* added by mysqlbinlog */ /*!*/;</span><br><span class="line">DELIMITER ;</span><br><span class="line"># End of log file</span><br><span class="line">/*!50003 SET COMPLETION_TYPE=@OLD_COMPLETION_TYPE*/;</span><br><span class="line">/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=0*/;</span><br></pre></td></tr></table></figure>

<p>这里我们用搜索去找 drop 等关键字，来找到删除操作的日志记录位置</p>
<p>可以看到以上内容，在第16行和第24行，分别删除了数据库test和test2，之后进行恢复数据库<code>test</code>操作，有两种方法:</p>
<p>这里我使用的是第一种</p>
<p>\1) 利用 drop database test 前的 “时间” 进行恢复，请注意时间格式</p>
<p>会产生一个警告，不用管，输入数据库root密码进行验证敲回车</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@iZm5eajbhqhhehk85j4d95Z data]# /www/server/mysql/bin/mysqlbinlog -d test --stop-datetime=&quot;2020-12-07 14:27:36&quot; mysql-bin.000001 | mysql -uroot -p;</span><br><span class="line">Enter password: WARNING: The option --database has been used. It may filter parts of transactions, but will include the GTIDs in any case. If you want to exclude or include transactions, you should use the options --exclude-gtids or --include-gtids, respectively, instead.</span><br><span class="line"></span><br><span class="line">[root@iZm5eajbhqhhehk85j4d95Z data]# </span><br></pre></td></tr></table></figure>

<p>\2) 利用 –stop-position=”” 进行恢复</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@iZm5eajbhqhhehk85j4d95Z data]# /www/server/mysql/bin/mysqlbinlog -d test --stop-position=&quot;2054&quot; mysql-bin.000001 | mysql -uroot -p;</span><br><span class="line">WARNING: The option --database has been used. It may filter parts of transactions, but will include the GTIDs in any case. If you want to exclude or include transactions, you should use the options --exclude-gtids or --include-gtids, respectively, instead.</span><br><span class="line">Enter password: </span><br><span class="line">[root@iZm5eajbhqhhehk85j4d95Z data]#</span><br></pre></td></tr></table></figure>

<p>再次进入数据库，可以看到数据库<code>test</code>以及数据就已经恢复了</p>
<h3 id="重置日志文件"><a href="#重置日志文件" class="headerlink" title="重置日志文件"></a>重置日志文件</h3><p>使用 mysqlbinlog 恢复之后，日志文件会重复记录前面的操作，此时可以选择重置日志文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; reset master</span><br></pre></td></tr></table></figure>

<p>再次查看二级制文件时，发现已经被重置了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> 1 mysql&gt; show binary logs;</span><br><span class="line"> 2 +------------------+-----------+</span><br><span class="line"> 3 | Log_name         | File_size |</span><br><span class="line"> 4 +------------------+-----------+</span><br><span class="line"> 5 | mysql-bin.000001 |      8079 |</span><br><span class="line"> 6 +------------------+-----------+</span><br><span class="line"> 7 1 row in set (0.00 sec)</span><br><span class="line"> 8 </span><br><span class="line"> 9 mysql&gt; reset master;</span><br><span class="line">10 Query OK, 0 rows affected (0.02 sec)</span><br><span class="line">11 </span><br><span class="line">12 mysql&gt; show binary logs;</span><br><span class="line">13 +------------------+-----------+</span><br><span class="line">14 | Log_name         | File_size |</span><br><span class="line">15 +------------------+-----------+</span><br><span class="line">16 | mysql-bin.000001 |       154 |</span><br><span class="line">17 +------------------+-----------+</span><br><span class="line">18 1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    
    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/php/d7fe6b68/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黑梦">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/php/d7fe6b68/" itemprop="url">PHP static 延迟静态绑定</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-11-17T23:14:00+08:00">
                2020-11-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/" itemprop="url" rel="index">
                    <span itemprop="name">php</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  669
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  2
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>首先看这种写法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span>(<span class="params"></span>): <span class="title">A</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">self</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">extends</span> <span class="title">A</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line">B::create();</span><br></pre></td></tr></table></figure>

<p>会成功实例化B吗？不会的，并且还会报错</p>
<hr>
<p>　　Error: Cannot instantiate abstract class A in D:\wamp64\www\test.php on line <em>6</em></p>
<hr>
<p>实际上，self对该类的作用与$this对对象的作用不完全相同。self不是指调用上下文，而是指解析上下文。因此，如果运行上面的例子，会报错，无法实例化抽象类</p>
<p>也就是说，self指向了定义了create()方法的A抽象类，而不是发送调用的B。在PHP5.3之前，这都是一种严格的限制，也出现了许多笨拙的解决方法。PHP5.3中引入了一种叫做延迟静态绑定的概念，最明显的特征就是关键字static。static与self类似，区别在于前者引用的是被调用的类。</p>
<p>这样写就能在静态上下文中利用继承关系了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span>(<span class="params"></span>): <span class="title">A</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">static</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">extends</span> <span class="title">A</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line">B::create();</span><br></pre></td></tr></table></figure>

<p>2.</p>
<p>static关键字的用处可不止实例化而已。和self、parent一样，static还可以被用作静态方法调用的标识符，在非静态上下文中也一样。看代码：</p>
<p>A类中有分类group的概念，默认情况下是”default“类，我也可以在类的继承层次的分支中改变这个类别</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$group</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;group = <span class="built_in">static</span>::getGroup();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span>(<span class="params"></span>): <span class="title">A</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">static</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getGroup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;default&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">extends</span> <span class="title">A</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> <span class="keyword">extends</span> <span class="title">A</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getGroup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;document&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> <span class="keyword">extends</span> <span class="title">C</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line">var_dump(B::create(), C::create(), D::create());</span><br></pre></td></tr></table></figure>

<p>我在A类中加入了一个构造方法，他会使用static关键字调用静态方法getGroup()。A类提供了“default”类别的实现。另外我还创建了一个新的类D，它继承自C。上面例子的输出结果为：</p>
<hr>
<p>D:\wamp64\www\test.php:34:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">object(B)[1]</span><br><span class="line">  private &#x27;group&#x27; </span><br></pre></td></tr></table></figure>

<p>(A)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">=&gt; </span><br></pre></td></tr></table></figure>

<p>string</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;default&#x27; (length=7)</span><br></pre></td></tr></table></figure>

<p>D:\wamp64\www\test.php:34:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">object(C)[2]</span><br><span class="line">  private &#x27;group&#x27; </span><br></pre></td></tr></table></figure>

<p>(A)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">=&gt; </span><br></pre></td></tr></table></figure>

<p>string</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;document&#x27; (length=8)</span><br></pre></td></tr></table></figure>

<p>D:\wamp64\www\test.php:35:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">object(D)[1]</span><br><span class="line">  private &#x27;group&#x27; </span><br></pre></td></tr></table></figure>

<p>(A)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">=&gt; </span><br></pre></td></tr></table></figure>

<p>string</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;document&#x27; (length=8)</span><br></pre></td></tr></table></figure>

<hr>
<p>对于D类，会先从被调用的D类自身开始找。由于它没有提供实现，C类中的getGroup()方法会被调用。</p>
<p>注意，假如把A类中 return new static() 改为 return new self()，那结果可就不一样了，就都会变成default了，因为使用self关键字的话，只有在实例化A(而不是D)时才能找到getGroup()</p>

          
        
      
    </div>
    
    
    
    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/mysql/48725857/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黑梦">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/mysql/48725857/" itemprop="url">MySQL Undo Log</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-11-14T21:17:00+08:00">
                2020-11-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2.1k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  7
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a><strong>基本概念</strong></h3><p>undo log 有两个作用：提供回滚和多个行版本控制(MVCC)。</p>
<p>在操作任何数据之前，首先将数据逻辑备份到undo log，然后进行数据修改。如果因为某些原因导致事务失败或回滚了，可以借助该undo log进行回滚。</p>
<p>undo log和redo log记录物理日志不一样，它是逻辑日志。<strong>可以认为当delete一条记录时，undo log中会记录一条对应的insert记录，反之亦然，当update一条记录时，它记录一条对应相反的update记录。</strong></p>
<p>当执行 rollback 时，就可以从undo log中的逻辑记录读取到相应的内容并进行回滚。有时候应用到行版本控制的时候，也是通过undo log来实现的：当读取的某一行被其他事务锁定时，它可以从undo log中分析出该行记录以前的数据是什么，从而提供该行版本信息，让用户实现非锁定一致性读取。</p>
<p><strong>undo log是采用段(segment)的方式来记录的，每个undo操作在记录的时候占用一个undo log segment</strong></p>
<p>另外，<strong>undo log</strong>也会产生redo log<strong>，因为undo log</strong>也要实现持久性保护。</p>
<h3 id="undo-log-的存储方式"><a href="#undo-log-的存储方式" class="headerlink" title="undo log 的存储方式"></a><strong>undo log 的存储方式</strong></h3><p>innodb 存储引擎对 undo 的管理采用段的方式。**rollback segment称为回滚段，每个回滚段中有1024个 undo log segment **</p>
<p>在以前老版本，只支持1个rollback segment，这样就只能记录1024个undo log segment。后来MySQL5.5可以支持128个rollback segment，即支持128*1024个undo操作，还可以通过变量 innodb_undo_logs (5.6版本以前该变量是 innodb_rollback_segments )自定义多少个rollback segment，默认值为128。</p>
<p>undo log默认存放在共享表空间中。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@xuexi data]# ll /mydata/data/ib*</span><br><span class="line">-rw-rw---- <span class="number">1</span> mysql mysql <span class="number">79691776</span> Mar <span class="number">31</span> <span class="number">01</span>:<span class="number">42</span> /mydata/data/ibdata1</span><br><span class="line">-rw-rw---- <span class="number">1</span> mysql mysql <span class="number">50331648</span> Mar <span class="number">31</span> <span class="number">01</span>:<span class="number">42</span> /mydata/data/ib_logfile0</span><br><span class="line">-rw-rw---- <span class="number">1</span> mysql mysql <span class="number">50331648</span> Mar <span class="number">31</span> <span class="number">01</span>:<span class="number">42</span> /mydata/data/ib_logfile1</span><br></pre></td></tr></table></figure>

<p>如果开启了<code>innodb_file_per_table</code> ，将放在每个表的.ibd文件中。</p>
<p>在MySQL5.6中，undo 的存放位置还可以通过变量 <code>innodb_undo_directory</code> 来自定义存放目录，默认值为”.”表示datadir。</p>
<p>默认<code>rollback segment</code>全部写在一个文件中，但可以通过设置变量 <code>innodb_undo_tablespaces</code>平均分配到多少个文件中。该变量默认值为 0，即全部写入一个表空间文件。该变量为静态变量，只能在<a target="_blank" rel="noopener" href="https://cloud.tencent.com/solution/database?from=10680">数据库</a>示例停止状态下修改，如写入配置文件或启动时带上对应参数。但是innodb存储引擎在启动过程中提示，不建议修改为非0的值，如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">01</span> <span class="number">13</span>:<span class="number">16</span>:<span class="number">00</span> 7f665bfab720 InnoDB: Expected to open <span class="number">3</span> undo tablespaces but was able</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">01</span> <span class="number">13</span>:<span class="number">16</span>:<span class="number">00</span> 7f665bfab720 InnoDB: to find only <span class="number">0</span> undo tablespaces.</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">01</span> <span class="number">13</span>:<span class="number">16</span>:<span class="number">00</span> 7f665bfab720 InnoDB: <span class="built_in">Set</span> the innodb_undo_tablespaces parameter to the</span><br><span class="line">-<span class="number">01</span>-<span class="number">01</span> :: f665bfab720 InnoDB: correct value and retry. Suggested value is </span><br></pre></td></tr></table></figure>

<h3 id="和undo-log相关的变量"><a href="#和undo-log相关的变量" class="headerlink" title="和undo log相关的变量"></a><strong>和undo log相关的变量</strong></h3><p>undo相关的变量在MySQL5.6中已经变得很少。如下：它们的意义在上文中已经解释了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> mysql&gt; show variables like <span class="string">&quot;%undo%&quot;</span>;</span><br><span class="line">+-------------------------+-------+</span><br><span class="line">| Variable_name           | Value |</span><br><span class="line">+-------------------------+-------+</span><br><span class="line">| innodb_undo_directory   | .     |</span><br><span class="line">| innodb_undo_logs        | <span class="number">128</span>   |</span><br><span class="line">| innodb_undo_tablespaces | <span class="number">0</span>     |</span><br><span class="line">+-------------------------+-------+</span><br></pre></td></tr></table></figure>

<h3 id="delete-update操作的内部机制"><a href="#delete-update操作的内部机制" class="headerlink" title="delete/update操作的内部机制"></a><strong>delete/update操作的内部机制</strong></h3><p>当事务提交的时候，innodb不会立即删除undo log，因为后续还可能会用到undo log，如隔离级别为repeatable read时，事务读取的都是开启事务时的最新提交行版本，只要该事务不结束，该行版本就不能删除，即undo log不能删除。</p>
<p>但是在事务提交的时候，会将该事务对应的undo log放入到删除列表中，未来通过purge来删除。并且提交事务时，还会判断undo log分配的页是否可以重用，如果可以重用，则会分配给后面来的事务，避免为每个独立的事务分配独立的undo log页而浪费存储空间和性能。</p>
<p>通过undo log记录delete和update操作的结果发现：(insert操作无需分析，就是插入行而已)</p>
<ul>
<li>delete操作实际上不会直接删除，而是将delete对象打上delete flag，标记为删除，最终的删除操作是purge线程完成的。</li>
<li>update分为两种情况：update的列是否是主键列。</li>
<li>如果不是主键列，在undo log中直接反向记录是如何update的。即update是直接进行的。</li>
<li>如果是主键列，update分两部执行：先删除该行，再插入一行目标行。</li>
</ul>
<h3 id="binlog和事务日志的先后顺序及group-commit"><a href="#binlog和事务日志的先后顺序及group-commit" class="headerlink" title="binlog和事务日志的先后顺序及group commit"></a><strong>binlog和事务日志的先后顺序及group commit</strong></h3><p>如果事务不是只读事务，即涉及到了数据的修改，默认情况下会在 commit 的时候调用 fsync() 将日志刷到磁盘，保证事务的持久性。</p>
<p>但是一次刷一个事务的日志性能较低，特别是事务集中在某一时刻时事务量非常大的时候。innodb提供了 group commit 功能，可以将多个事务的事务日志通过一次fsync()刷到磁盘中。</p>
<p>因为事务在提交的时候不仅会记录事务日志，还会记录二进制日志，但是它们谁先记录呢？二进制日志是<a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/cdb?from=10680">MySQL</a>的上层日志，先于存储引擎的事务日志被写入。</p>
<p>在MySQL5.6以前，当事务提交(即发出commit指令)后，MySQL接收到该信号进入commit prepare阶段；进入prepare阶段后，立即写内存中的二进制日志，写完内存中的二进制日志后就相当于确定了commit操作；然后开始写内存中的事务日志；最后将二进制日志和事务日志刷盘，它们如何刷盘，分别由变量 sync_binlog 和 innodb_flush_log_at_trx_commit 控制。</p>
<p>但因为要保证二进制日志和事务日志的一致性，在提交后的prepare阶段会启用一个<strong>prepare_commit_mutex</strong>锁来保证它们的顺序性和一致性。但这样会导致开启二进制日志后group commmit失效，特别是在主从复制结构中，几乎都会开启二进制日志。</p>
<p>在MySQL5.6 中进行了改进。提交事务时，在存储引擎层的上一层结构中会将事务按序放入一个队列，队列中的第一个事务称为 leader，其他事务称为 follower，leader 控制着 follower 的行为。虽然顺序还是一样先刷二进制，再刷事务日志，但是机制完全改变了：删除了原来的prepare_commit_mutex 行为，也能保证即使开启了二进制日志，group commit 也是有效的。</p>
<p>MySQL5.6中分为3个步骤：**flush阶段、sync阶段、commit阶段。</p>
<img src="../../images/UndoLog/image-20211114213419955.png" alt="image-20211114213419955" style="zoom:67%;" />

<ul>
<li>flush阶段：向内存中写入每个事务的二进制日志。</li>
<li>sync阶段：将内存中的二进制日志刷盘。若队列中有多个事务，那么仅一次 fsync 操作就完成了二进制日志的刷盘操作。这在 MySQL5.6 中称为BLGC(<code>binary log group commit</code>)。</li>
<li>commit阶段：leader根据顺序调用存储引擎层事务的提交，由于innodb本就支持group commit，所以解决了因为锁 <code>prepare_commit_mutex</code> 而导致的group commit失效问题。</li>
</ul>
<p>在flush阶段写入二进制日志到内存中，但是不是写完就进入sync阶段的，而是要等待一定的时间，多积累几个事务的 binlog 一起进入 sync 阶段，等待时间由变量<code>binlog_max_flush_queue_time</code> 决定，默认值为 0 表示不等待直接进入 sync，设置该变量为一个大于0的值的好处是group中的事务多了，性能会好一些，但是这样会导致事务的响应时间变慢，所以建议不要修改该变量的值，除非事务量非常多并且不断的在写入和更新。</p>
<p>进入到 sync 阶段，会将 binlog 从内存中刷入到磁盘，刷入的数量和单独的二进制日志刷盘一样，由变量 sync_binlog 控制。</p>
<p>当有一组事务在进行 commit 阶段时，其他新事务可以进行 flush 阶段，它们本就不会相互阻塞，所以 group commit 会不断生效。当然，group commit 的性能和队列中的事务数量有关，如果每次队列中只有1个事务，那么 group commit 和单独的 commit 没什么区别，当队列中事务越来越多时，即提交事务越多越快时，group commit 的效果越明显。</p>

          
        
      
    </div>
    
    
    
    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/mysql/dacc1947/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黑梦">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/mysql/dacc1947/" itemprop="url">MySQL 底层架构原理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-11-14T19:51:00+08:00">
                2020-11-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.3k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  4
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>转自：<a target="_blank" rel="noopener" href="https://www.shulanxt.com/doc/mysqldoc/dcyls">https://www.shulanxt.com/doc/mysqldoc/dcyls</a></p>
<h3 id="连接管理"><a href="#连接管理" class="headerlink" title="连接管理"></a>连接管理</h3><p>系统（客户端）访问<code>MySQL</code>服务器前，做的第一件事就是建立<code>TCP</code>连接。</p>
<p>经过三次握手建立连接成功后，<code>MySQL</code>服务器对<code>TCP</code>传输过来的账号密码做身份认证、权限获取。</p>
<ul>
<li><strong>用户名或密码不对，会收到一个Access denied for user错误，客户端程序结束执行</strong></li>
<li><strong>用户名密码认证通过，会从权限表查出账号拥有的权限与连接关联，之后的权限判断逻辑，都将依赖于此时读到的权限</strong></li>
</ul>
<p>接着我们来思考一个问题</p>
<p>一个系统只会和<code>MySQL</code>服务器建立一个连接吗？</p>
<p>只能有一个系统和<code>MySQL</code>服务器建立连接吗？</p>
<p>当然不是，多个系统都可以和<code>MySQL</code>服务器建立连接，每个系统建立的连接肯定不止一个。</p>
<p>所以，为了解决<code>TCP</code>无限创建与<code>TCP</code>频繁创建销毁带来的资源耗尽、性能下降问题。</p>
<p><code>MySQL</code>服务器里有专门的<code>TCP</code>连接池限制接数，采用长连接模式复用<code>TCP</code>连接，来解决上述问题。</p>
<p><img src="../../images/%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86/%E6%9C%AA%E5%91%BD%E5%90%8D1628429614-1-1024x873.png" alt="MySQL底层原理,MySQL连接管理,MySQL服务器,MySql架构"></p>
<p><code>TCP</code>连接收到请求后，必须要分配给一个线程去执行，所以还会有个线程池，去走后面的流程。</p>
<p>这些内容我们都归纳到<code>MySQL</code>的<strong>连接管理</strong>组件中。</p>
<p>所以<strong>连接管理</strong>的职责是负责认证、管理连接、获取权限信息。</p>
<h3 id="解析与优化"><a href="#解析与优化" class="headerlink" title="解析与优化"></a>解析与优化</h3><p>经过了连接管理，现在<code>MySQL</code>服务器已经获取到<code>SQL</code>字符串。</p>
<p>如果是查询语句，<code>MySQL</code>服务器会使用<code>select SQL</code>字符串作为<code>key</code>。</p>
<p>去缓存中获取，命中缓存，直接返回结果（<strong>返回前需要做权限验证</strong>），未命中执行后面的阶段，这个步骤叫<strong>查询缓存</strong>。</p>
<p><img src="../../images/%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86/%E6%9C%AA%E5%91%BD%E5%90%8D1628429614-2-1024x825.png" alt="MySQL底层原理,MySQL连接管理,MySQL服务器,MySql架构"></p>
<p>需要注意，<code>select SQL</code>字符串要完全匹配，有任何不同的地方都会导致缓存不被命中（<strong>空格、注释、大小写、某些系统函数</strong>）。</p>
<blockquote>
<p>小贴士：虽然查询缓存有时可以提升系统性能，但也不得不因维护这块缓存而造成一些开销，从MySQL 5.7.20开始，不推荐使用查询缓存，并在MySQL 8.0中删除。</p>
</blockquote>
<p>没有命中缓存，或者非<code>select SQL</code>就来到<strong>分析器</strong>阶段了。</p>
<p>因为系统发送过来的只是一段文本字符串，所以<code>MySQL</code>服务器要按照<code>SQL</code>语法对这段文本进行解析。</p>
<p><img src="../../images/%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86/%E6%9C%AA%E5%91%BD%E5%90%8D1628429614-3-1024x801.png" alt="MySQL底层原理,MySQL连接管理,MySQL服务器,MySql架构"></p>
<p>如果你的<code>SQL</code>字符串不符合语法规范，就会收到<code>You have an error in your SQL syntax</code>错误提醒</p>
<p>通过了<strong>分析器</strong>，说明<code>SQL</code>字符串符合语法规范，现在<code>MySQL</code>服务器要执行<code>SQL</code>语句了。</p>
<p><code>MySQL</code>服务器要怎么执行呢？</p>
<p>你需要产出执行计划，交给<code>MySQL</code>服务器执行，所以来到了<strong>优化器</strong>阶段。</p>
<p><img src="../../images/%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86/%E6%9C%AA%E5%91%BD%E5%90%8D1628429614-4-1024x918.png" alt="MySQL底层原理,MySQL连接管理,MySQL服务器,MySql架构"></p>
<p>优化器不仅仅只是生成执行计划这么简单，这个过程它会帮你优化<code>SQL</code>语句。</p>
<p>如<strong>外连接转换为内连接、表达式简化、子查询转为连接、连接顺序、索引选择</strong>等一堆东西，优化的结果就是执行计划。</p>
<p>截止到现在，还没有真正去读写真实的表，仅仅只是产出了一个执行计划。</p>
<p>于是就进入了<strong>执行器</strong>阶段，<code>MySQL</code>服务器终于要执行<code>SQL</code>语句了。</p>
<p><img src="../../images/%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86/%E6%9C%AA%E5%91%BD%E5%90%8D1628429614-5-1024x885.png" alt="MySQL底层原理,MySQL连接管理,MySQL服务器,MySql架构"></p>
<p>开始执行的时候，要先判断一下对这个表有没有相应的权限，如果没有，就会返回权限错误。</p>
<p>如果有权限，根据执行计划调用存储引擎<code>API</code>对表进行的读写。</p>
<p><img src="../../images/%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86/%E6%9C%AA%E5%91%BD%E5%90%8D1628429614-6-887x1024.png" alt="MySQL底层原理,MySQL连接管理,MySQL服务器,MySql架构"></p>
<p>存储引擎<code>API</code>只是抽象接口，下面还有个<strong>存储引擎层</strong>，具体实现还是要看表选择的存储引擎。</p>
<p>讲到这里，上面提到的<strong>查询缓存、分析器、优化器、执行器</strong>都可以归纳到<code>MySQL</code>的<strong>解析与优化</strong>组件中。</p>
<p>所以<strong>解析与优化</strong>的职责如下：</p>
<ul>
<li><strong>缓存</strong></li>
<li><strong>SQL语法解析验证</strong></li>
<li><strong>SQL优化并生成执行计划</strong></li>
<li><strong>根据执行计划调用存储引擎接口</strong></li>
</ul>
<p><img src="../../images/%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86/%E6%9C%AA%E5%91%BD%E5%90%8D1628429614-7-887x1024.png" alt="MySQL底层原理,MySQL连接管理,MySQL服务器,MySql架构"></p>
<p>其中<strong>连接管理</strong>与<strong>解析与优化</strong>处于<code>MySQL</code>架构中的<code>Server</code>层。</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>在学习任何知识前，先不要着急的陷入细节，而是先了解大致脉络，有个全局观，之后再去深入相关的细节。</p>
<p><code>MySql</code>架构分为<code>Servce</code>层与<strong>存储引擎</strong>层。</p>
<p><strong>连接管理、解析与优化</strong>这些并不涉及读写表数据的组件划分到<code>Servce</code>层，读写表数据而是交给<strong>存储引擎层</strong>来做。</p>
<p>通过这种架构设计，我们发现<code>Servce</code>层其实就是公用层，<strong>存储引擎层</strong>就是多态层，按需选择具体的存储引擎。</p>
<p>再细想下，它和<strong>模板方法设计模式</strong>一摸一样，它们的执行流程是固定的，<code>Servce</code>层等于公用模板函数，<strong>存储引擎层</strong>等于抽象模板函数，按需子类实现。</p>
<p>阿星最后以一张<code>MySQL</code>简化版的架构图结束本文，我们下期再见~</p>
<p><img src="../../images/%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86/%E6%9C%AA%E5%91%BD%E5%90%8D1628429614-8.png" alt="MySQL底层原理,MySQL连接管理,MySQL服务器,MySql架构"></p>

          
        
      
    </div>
    
    
    
    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/javascript/8f45c573/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黑梦">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/javascript/8f45c573/" itemprop="url">ElementUI el-select下拉选择框默认显示</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-11-08T00:55:00+08:00">
                2020-11-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/javascript/" itemprop="url" rel="index">
                    <span itemprop="name">javascript</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  144
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-select v-model=&quot;goodsDetail.gift_coupons&quot; placeholder=&quot;无&quot; style=&quot;width:300px&quot;&gt;</span><br><span class="line">    &lt;el-option :label=&quot;item.name&quot; :value=&quot;item.id&quot; v-for=&quot;(item,id) in couponsList&quot; :key=&quot;item.id&quot;&gt;</span><br><span class="line">    &lt;/el-option&gt;</span><br><span class="line">&lt;/el-select&gt;</span><br></pre></td></tr></table></figure>

<p><strong>方法：</strong></p>
<p>在加载时给 goodsDetail.gift_coupons 默认值，这个默认值为 代码第二行中的 item.id 中的其中一个</p>
<p><strong>注意：</strong></p>
<p>好像给的这个默认值要和 item.id的 类型一样，要注意一下，反正如果 :value 绑定的是数字，若出不来效果，就试试 string 或 number 哪个类型可以</p>
<p><strong>效果：</strong></p>
<p><img src="../../images/ElementUI_el-select%E4%B8%8B%E6%8B%89%E9%80%89%E6%8B%A9%E6%A1%86%E9%BB%98%E8%AE%A4%E6%98%BE%E7%A4%BA/2020519-20201108005401898-1869011592.png" alt="img"></p>

          
        
      
    </div>
    
    
    
    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/php/39f83996/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黑梦">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/php/39f83996/" itemprop="url">tp5一对多，a表hasmany b表，b表hasmany c表</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-11-08T00:18:00+08:00">
                2020-11-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/" itemprop="url" rel="index">
                    <span itemprop="name">php</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  82
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在a model定义b model关联</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hasManyB</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;hasMany(<span class="string">&#x27;关联模型b的模型名&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 在b model定义c model关联</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hasManyC</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;hasMany(<span class="string">&#x27;关联模型c的模型名&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 在a model中执行查询</span></span><br><span class="line"><span class="variable">$result</span> = <span class="keyword">$this</span>-&gt;with([<span class="string">&#x27;hasManyB&#x27;</span> =&gt; [<span class="string">&#x27;hasManyC&#x27;</span>]])-&gt;where(<span class="variable">$where</span>)-&gt;order(<span class="variable">$order</span>)-&gt;select();</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    
    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/">上一页</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/">下一页</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">43</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">blackdream</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">36.1k</span>
  
</div>

  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>


  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('/n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
          if(result)$(this).text('success')
          else $(this).text('fail')
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('copy')
        }, 300)
      }).append(e)
    })
  </script>


</body>
</html>
